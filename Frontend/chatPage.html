<!DOCTYPE html>
<html>
    <head>
        <title>Chat Page</title>
        <link rel="stylesheet" type="text/css" href="css/CPStyles.css" />
        <link
            rel="stylesheet"
            href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />
    </head>
    <body>
        <div class="chat-container">
            <section class="chat-messages" id="msgBox"></section>

            <div class="chat-input">
                <input
                    type="text"
                    id="myMsg"
                    placeholder="Enter your message"
                    style="color: white"
                    required />
                <button
                    class="fas fa-chevron-right"
                    onclick="displayMsg()"></button>
                <p class="output"></p>
                <div id="timestamp" class="timestamp"></div>
            </div>

            <!--temporary input box to test displaying received messages. Delect this secetion in the future-->
            <!-- <div class="chat-input">
                <input
                    type="text"
                    id="recMsg"
                    placeholder="this is for received message"
                    style="color: white"
                    required />
                <button
                    class="fas fa-chevron-right"
                    onclick="displayRecMsg()"></button>
                <p class="output"></p>
                <div id="timestamp" class="timestamp"></div>
            </div> -->
        </div>
    </body>
</html>

<script>
    var roomName = "global"; // Replace with actual room name
    var socket = new WebSocket("ws://127.0.0.1:8000/ws/chat/" + roomName + "/");

    socket.onopen = function () {
        console.log("WebSocket connection established.");
    };

    socket.onmessage = function (event) {
        var message = event.data;
        console.log("Received message:", message);
        displayRecMsg(message);
    };

    socket.onclose = function (event) {
        console.log("WebSocket connection closed with code:", event.code);
        // Probably want to log them out and return to landing page as well
    };

    socket.onerror = function (event) {
        console.error("WebSocket connection closed with code:", event.code);
        // Probably want to log them out and return to landing page as well
    };

    function sendMsg() {
        const input = document.querySelector("#myMsg");
        if (input.value.trim() === "") {
            alert("Please enter a message before sending");
            return;
        }

        const msg = {
            // user:
            text: input.value,
            timestamp: new Date().toLocaleDateString(),
        };

        socket.send(JSON.stringify(msg));

        input.value = ""; // Clear the input field
    }

    function displayMsg() {
        const input = document.querySelector("#myMsg");
        const output = document.querySelector("#msgBox");
        const newMsg = document.createElement("p");
        const time = document.createElement("p");

        // if (input.value.trim() === "") {
        //     alert("Please enter a message before sending");
        //     return;
        // }

        const now = new Date();
        const timeString = now.toLocaleTimeString();
        time.textContent = timeString;
        time.classList.add("timestamp-sent");

        newMsg.textContent = input.value;
        newMsg.classList.add("chat-bubble-sent");
        output.appendChild(newMsg);
        output.appendChild(time);
        input.value = ""; // Clear the input field
    }

    function displayRecMsg(json) {
        const msg = JSON.parse(json);
        // const input = document.querySelector("#recMsg");
        const output = document.querySelector("#msgBox");
        const newMsg = document.createElement("p");
        const user = document.createElement("p");
        const time = document.createElement("p");

        time.textContent = msg.timestamp;
        time.classList.add("timestamp-rec");

        // TODO replace with actual username
        user.textContent = "user1";
        user.classList.add("userName");

        newMsg.textContent = msg.text;
        newMsg.classList.add("chat-bubble-rec");

        output.appendChild(user);
        output.appendChild(newMsg);
        output.appendChild(time);
    }
</script>
